{% extends "base.html" %} 

{% block title %}Verificação ao Vivo - Reconhecedor de Imagens{% endblock %}
{% block page_title %}Verificação ao Vivo{% endblock %}

{% block content %}
<div class="live-verification-container">
    <div class="controls">
        {% if processing_active %}
            <a href="{{ url_for('stop_live_processing') }}" class="btn btn-danger" id="stop-button">Parar Processamento</a>
        {% else %}
            <a href="{{ url_for('start_live_processing') }}" class="btn btn-success" id="start-button">Iniciar Processamento ao vivo</a>
        {% endif %}
        
        <!-- Botões de Captura Contínua -->
        <button class="btn btn-primary" id="start-capture-button" style="margin-left: 10px;">Iniciar Captura Contínua</button>
        <button class="btn btn-danger" id="stop-capture-button" style="margin-left: 10px; display: none;">Parar Captura Contínua</button>
    </div>
    
    <!-- Adicionando margem para manter o layout consistente -->
    <div class="video-container" style="margin-top: 20px;">
        <div id="loading-message" style="display: block; width: 640px; height: 480px; background-color: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px;">
            Esperando...
        </div>
        <img src="{{ url_for('live_feed') }}" alt="Imagem ao Vivo" id="live-image" style="display: none;">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let processingActive = {{ processing_active | tojson }};
    let updateInterval;
    let captureIntervalId;

    function updateFeed() {
        if (processingActive) {
            const liveImage = document.getElementById('live-image');
            const loadingMessage = document.getElementById('loading-message');

            liveImage.onload = function() {
                // Quando a imagem carregar, esconda a mensagem de carregamento
                loadingMessage.style.display = 'none';
                liveImage.style.display = 'block';
            };

            liveImage.onerror = function() {
                // Se ocorrer erro ao carregar a imagem, exiba a mensagem de carregamento
                loadingMessage.style.display = 'flex';
                liveImage.style.display = 'none';
            };

            liveImage.src = "{{ url_for('live_feed') }}" + "?t=" + new Date().getTime();
        }
    }

    function startUpdatingFeed() {
        if (processingActive) {
            updateInterval = setInterval(updateFeed, 500);
        }
    }

    function stopUpdatingFeed() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    }

    // Função para checar o status do modelo/processamento
    function checkProcessingStatus() {
        fetch('{{ url_for("check_model_status") }}')
            .then(response => {
                if (response.status === 200) {
                    processingActive = true;
                    startUpdatingFeed();
                } else {
                    // Tentar novamente em 500ms se o processamento ainda não estiver pronto
                    setTimeout(checkProcessingStatus, 500);
                }
            })
            .catch(error => {
                console.error("Erro ao verificar o status do modelo:", error);
            });
    }

    // Listener para o botão de iniciar processamento ao vivo
    document.getElementById('start-button')?.addEventListener('click', (e) => {
        e.preventDefault();  // Impede o redirecionamento imediato para a página de verificação
        if (!processingActive) {
            processingActive = true;
            checkProcessingStatus();
            window.location.href = e.target.href;  // Redireciona após iniciar o processo
        }
    });

    // Listener para o botão de parar processamento
    document.getElementById('stop-button')?.addEventListener('click', (e) => {
        processingActive = false;
        stopUpdatingFeed();
    });

    // Inicia a atualização do feed se o processamento estiver ativo
    if (processingActive) {
        startUpdatingFeed();
    }

    // Função para iniciar captura contínua
    document.getElementById('start-capture-button').addEventListener('click', function() {
        fetch('{{ url_for("start_continuous_capture") }}', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    // Alterar os botões após iniciar a captura
                    document.getElementById('start-capture-button').style.display = 'none';
                    document.getElementById('stop-capture-button').style.display = 'inline-block';
                    alert("Captura contínua iniciada.");
                } else {
                    alert("Falha ao iniciar a captura contínua.");
                }
            })
            .catch(error => {
                console.error("Erro ao iniciar captura contínua:", error);
            });
    });

    // Função para parar captura contínua
    document.getElementById('stop-capture-button').addEventListener('click', function() {
        fetch('{{ url_for("stop_continuous_capture") }}', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    // Alterar os botões após parar a captura
                    document.getElementById('start-capture-button').style.display = 'inline-block';
                    document.getElementById('stop-capture-button').style.display = 'none';
                    alert("Captura contínua parada.");
                } else {
                    alert("Falha ao parar a captura contínua.");
                }
            })
            .catch(error => {
                console.error("Erro ao parar captura contínua:", error);
            });
    });
</script>
{% endblock %}
